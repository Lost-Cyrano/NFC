<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partage NFC - Solution améliorée</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #0575e6, #021b79);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            min-height: 150px;
            resize: none;
            font-size: 1rem;
        }
        
        .btn {
            background: linear-gradient(to right, #00c853, #64dd17);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-box {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            background: #f5f5f5;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .status-text {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-detail {
            font-size: 0.9rem;
            color: #666;
        }
        
        .error {
            color: #d32f2f;
        }
        
        .success {
            color: #388e3c;
        }
        
        .warning {
            color: #ffa000;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .debug-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #666;
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Partage NFC Pro</h1>
            <p>Solution améliorée de partage sans contact</p>
        </header>
        
        <div class="content">
            <div class="form-group">
                <label for="message">Informations à partager :</label>
                <textarea id="message" placeholder="Écrivez ici les informations à transférer...">Mon numéro: 0606060606
Disponible de 12h30 à 14h00
Autres informations...</textarea>
            </div>
            
            <button id="shareBtn" class="btn">
                Activer le partage NFC
            </button>
            
            <div class="status-box" id="statusBox">
                <div class="status-icon" id="statusIcon">⇅</div>
                <h3 class="status-text" id="statusText">Prêt à partager</h3>
                <p class="status-detail" id="detailText">Cliquez sur le bouton pour activer le NFC</p>
                <div class="debug-info" id="debugInfo"></div>
            </div>
            
            <div class="instructions">
                <h3>Mode d'emploi :</h3>
                <ol>
                    <li>Activez le NFC dans les paramètres de votre téléphone</li>
                    <li>Déverrouillez votre écran</li>
                    <li>Approchez les téléphones dos à dos (1-2 cm)</li>
                    <li>Maintenez la position jusqu'au transfert</li>
                    <li>Le téléphone client recevra automatiquement les informations</li>
                </ol>
            </div>
        </div>
        
        <footer>
            Compatible avec les appareils Android (Chrome 89+)
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const shareBtn = document.getElementById('shareBtn');
            const statusBox = document.getElementById('statusBox');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const detailText = document.getElementById('detailText');
            const debugInfo = document.getElementById('debugInfo');
            const messageInput = document.getElementById('message');
            
            let nfcReader;
            let isSharing = false;
            
            // Vérifier la compatibilité NFC
            function checkNFCSupport() {
                if (!('NDEFReader' in window)) {
                    updateStatus('error', 'NFC non supporté', 
                        'Votre navigateur ou appareil ne supporte pas Web NFC');
                    shareBtn.disabled = true;
                    return false;
                }
                return true;
            }
            
            // Mettre à jour l'état de l'interface
            function updateStatus(type, text, detail, debug = '') {
                // Réinitialiser les classes
                statusBox.className = 'status-box';
                statusIcon.className = 'status-icon';
                statusText.className = 'status-text';
                
                // Ajouter les classes appropriées
                statusBox.classList.add(type);
                statusIcon.classList.add(type);
                statusText.classList.add(type);
                
                // Mettre à jour le texte
                statusText.textContent = text;
                detailText.textContent = detail;
                
                // Afficher les infos de débogage si nécessaire
                if (debug) {
                    debugInfo.style.display = 'block';
                    debugInfo.textContent = debug;
                } else {
                    debugInfo.style.display = 'none';
                }
                
                // Changer l'icône selon le type
                switch(type) {
                    case 'error':
                        statusIcon.textContent = '✖';
                        break;
                    case 'success':
                        statusIcon.textContent = '✓';
                        break;
                    case 'warning':
                        statusIcon.textContent = '⚠';
                        break;
                    default:
                        statusIcon.textContent = '⇅';
                }
            }
            
            // Démarrer le partage NFC
            async function startSharing() {
                try {
                    updateStatus('warning', 'Activation NFC...', 
                        'Initialisation en cours...');
                    
                    nfcReader = new NDEFReader();
                    
                    // Configurer les gestionnaires d'événements avant de scanner
                    nfcReader.onreading = (event) => {
                        updateStatus('warning', 'Détection...', 
                            'Téléphone détecté, préparation du transfert...');
                    };
                    
                    nfcReader.onreadingerror = (error) => {
                        updateStatus('error', 'Erreur de lecture', 
                            'Échec de la lecture du tag NFC', 
                            `Erreur: ${error.message || 'Inconnue'}`);
                    };
                    
                    await nfcReader.scan();
                    isSharing = true;
                    shareBtn.textContent = "Arrêter le partage";
                    updateStatus('success', 'Partage activé', 
                        'Approchez les téléphones dos à dos...');
                    
                    // Vérifier périodiquement que le NFC est toujours actif
                    const checkInterval = setInterval(() => {
                        if (!isSharing) clearInterval(checkInterval);
                        updateNFCAvailability();
                    }, 3000);
                    
                } catch (error) {
                    console.error("Erreur NFC:", error);
                    handleNFCError(error);
                }
            }
            
            // Arrêter le partage NFC
            function stopSharing() {
                isSharing = false;
                nfcReader = null;
                shareBtn.textContent = "Activer le partage NFC";
                updateStatus('', 'Partage désactivé', 
                    'Cliquez sur le bouton pour activer');
            }
            
            // Gérer les erreurs NFC
            function handleNFCError(error) {
                let errorMessage = "Erreur inconnue";
                let detailMessage = "Veuillez réessayer";
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = "Permission refusée";
                    detailMessage = "Veuillez autoriser l'accès NFC dans les paramètres";
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = "NFC non supporté";
                    detailMessage = "Votre appareil ne supporte pas cette fonctionnalité";
                } else if (error.message.includes('NFC not available')) {
                    errorMessage = "NFC non disponible";
                    detailMessage = "Activez le NFC dans les paramètres de votre téléphone";
                } else {
                    errorMessage = "Erreur technique";
                    detailMessage = error.message || "Une erreur est survenue";
                }
                
                updateStatus('error', errorMessage, detailMessage, 
                    `Code: ${error.name || 'Inconnu'}`);
                stopSharing();
            }
            
            // Vérifier la disponibilité du NFC
            async function updateNFCAvailability() {
                try {
                    if (!isSharing) return;
                    
                    // Vérifier si on peut écrire (test simplifié)
                    const testRecord = {
                        recordType: "mime",
                        mediaType: "text/plain",
                        data: new TextEncoder().encode("test")
                    };
                    
                    await nfcReader.write({
                        records: [testRecord]
                    }, { timeout: 100 }).catch(() => {});
                    
                } catch (error) {
                    handleNFCError(error);
                }
            }
            
            // Gestionnaire du bouton de partage
            shareBtn.addEventListener('click', async () => {
                if (!checkNFCSupport()) return;
                
                if (!isSharing) {
                    await startSharing();
                } else {
                    stopSharing();
                }
            });
            
            // Vérifier les permissions au chargement
            async function checkPermissions() {
                try {
                    if (navigator.permissions && navigator.permissions.query) {
                        const status = await navigator.permissions.query({
                            name: 'nfc'
                        });
                        
                        if (status.state === 'denied') {
                            updateStatus('error', 'Permission refusée', 
                                'Veuillez autoriser l\'accès NFC dans les paramètres');
                            shareBtn.disabled = true;
                        }
                    }
                } catch (err) {
                    console.log("L'API Permissions n'est pas supportée");
                }
            }
            
            // Initialisation
            checkNFCSupport();
            checkPermissions();
        });
    </script>
</body>
</html>
